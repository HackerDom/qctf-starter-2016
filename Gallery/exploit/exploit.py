import piexif
from pprint import pprint


def exploit(
        filename,
        new_lat_ref=None,
        new_lat_degrees=None,
        new_long_ref=None,
        new_long_degrees=None,
        new_filename=None):
    with open(filename, 'rb') as f:
        jpeg_bytes = f.read()
    exif = piexif.load(jpeg_bytes)
    if 'GPS' not in exif:
        print('Cannot exploit {}: no geotag in the file'.format(filename))
        return
    gps = exif['GPS']
    if len(gps) < 5:
        print('Cannot exploit {}: not enough info in the geotag'.format(filename))
        return
    lat_ref, lat_degrees, long_ref, long_degrees = gps[1], gps[2], gps[3], gps[4]
    lat_degrees = lat_degrees[0][0]
    long_degrees = long_degrees[0][0]
    print('Current coordinates:', lat_ref, lat_degrees, long_ref, long_degrees)
    if new_lat_ref is None:
        new_lat_ref = lat_ref
    if new_lat_degrees is None:
        new_lat_degrees = lat_degrees
    if new_long_ref is None:
        new_long_ref = long_ref
    if new_long_degrees is None:
        new_long_degrees = long_degrees
    gps[1] = new_lat_ref
    gps[2] = ((new_lat_degrees, 1), *gps[2][1:])
    gps[3] = new_long_ref
    gps[4] = ((new_long_degrees, 1), *gps[4][1:])
    exif_bytes = piexif.dump(exif)
    piexif.insert(exif_bytes, filename, new_filename)
    print('Successfully modified {}: lat_ref={}, lat_degrees={}, long_ref={}, long_degrees={}'
          .format(filename, new_lat_ref, new_lat_degrees, new_long_ref, new_long_degrees))
    print('Saved into {}'.format(new_filename))


if __name__ == '__main__':
    exploit('exploit.jpg',
            new_lat_ref=b'N',
            new_lat_degrees=None,
            new_long_ref=b'E',
            new_long_degrees=None,
            new_filename='modified_exploit.jpg')
