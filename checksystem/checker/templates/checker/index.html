{% extends "qctf_checksystem/base.html" %}

{% block title %}Правительство{% endblock %}

{% block content %}
  <div class="tim-title">
    {% if not user.team.contest_started %}
      <h2>Дождитесь начала контеста</h2>
    {% else %}
      {% for task in tasks %}
        {% if not task.parent or user.team in task.parent.teams.all %}
          {% if forloop.first %}
            <div class="row">
          {% endif %}
          <div class="col-xs-4">
            <div class="card card-block task-block {% if user.team in task.teams.all %}task-solved-block{% endif %}" id="card-{{ task.pk }}" data-toggle="modal" data-target="#modal-{{ task.pk }}">
              <div class="card-title">
                <h4 class="card-title">
                  <span>{{ task.title }}</span>
                  <span class="pull-right">{{ task.price }} <i class="fa fa-bitcoin"></i></span>
                </h4>
                {# <h5 class="card-title">Стоимость: {{ task.price }} $</h5> #}
              </div>
              <p class="card-text">{{ task.description|safe|truncatechars_html:185 }}</p>
            </div>
            <div class="modal fade {% if user.team in task.teams.all %}task-solved-modal{% endif %}" id="modal-{{ task.pk }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel-{{ task.pk }}" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content task-modal">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="modalLabel-{{ task.pk }}">{{ task.title }}</h4>
                    <span>Решили {{ task.teams.count }} команд.</span>
                  </div>
                  <div class="modal-body">
                    <div class="stamp"></div>
                    {{ task.description|safe }}
                  </div>
                  <div class="modal-footer">
                    <div class="form-group">
                      <input type="text" class="form-control flag-input-{{ task.pk }}" placeholder="Флаг">
                      <span id="task-{{ task.pk }}-status"></span>
                    </div>
                    <button type="button" task-id="{{ task.pk }}" class="btn btn-success submit-flag-button">Отправить</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% if forloop.counter|divisibleby:3 %}
            </div><div class="row">
          {% endif %}
          {% if forloop.last %}
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

{% endblock %}

{% block scripts %}
  <script>
    var need_refresh = false;
    $(function() {
      $('.modal').on('hidden.bs.modal', function () {
        console.log(need_refresh);
        if (need_refresh) {
          location.reload();
        }
      });


      $('.submit-flag-button').click(function() {
        var task_id = $(this).attr('task-id');
        var flag = $('.flag-input-' + task_id).val();
        $.ajax({
          type: "POST",
          url: '/check_flag/' + task_id + '/',
          data: {flag: flag},
          success: function(data) {
            if ('need_refresh' in data) {
              need_refresh = data.need_refresh;
            }
            $("#task-" + task_id + "-status").show();
            $("#task-" + task_id + "-status").text(data.message);
            $('#balance').text(data.balance);
            $('#flags-number').text(data.flags);
            $("#task-" + task_id + "-status").fadeOut(4000, function() {});
            if (data.is_correct) {
              need_refresh = true;
              $("#card-" + task_id).addClass("task-solved-block");
              $("#modal-" + task_id).addClass("task-solved-modal");
            }
          },
          dataType: 'json'
        });
      });
    });
  </script>
{% endblock %}
